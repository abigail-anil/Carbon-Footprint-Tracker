{% extends "CarbonTracker/base_generic.html" %}
{% block extra_head %}
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <style>
    /* Center the pagination container */
    .dataTables_wrapper .dataTables_paginate {
  text-align: center;
  margin-top: 1em;
}
.dataTables_wrapper .dataTables_paginate .paginate_button {
  display: inline-block !important;
  padding: 6px 12px !important;
  margin: 0 5px !important;
  border: 1px solid #ddd !important;
  border-radius: 3px !important;
  background-color: #fff !important;
  color: #333 !important;
  cursor: pointer !important;
}
.dataTables_wrapper .dataTables_paginate .paginate_button:hover {
  background-color: #e9e9e9 !important;
}

  </style>
{% endblock extra_head %}


{% block content %}
<div style="display: flex; min-height: 100vh;">
    <div style="width: 200px; background-color: #e0e0e0; padding: 10px; font-size: 1.2em;">
        <a href="{% url 'calculate_emission' %}" style="font-size: 1.2em; display: block;">Calculate Emission</a><br><br>
        <a href="{% url 'emission_reports' %}" style="font-size: 1.2em; display: block;">Emission Reports</a>
    </div>
    <div style="flex-grow: 1; padding: 20px; font-size: 1.2em;">
        <h1 style="text-align: center; font-size: 1.5em;">Emission Reports</h1>

        <div style="margin-top: 20px;">
            <form method="get">
                <div style="display: flex; justify-content: space-between; width: 100%;">
                    <label for="start_date">Start Date: <input type="date" name="start_date" value="{{ start_date }}"></label>
                    <label for="end_date">End Date: <input type="date" name="end_date" value="{{ end_date }}" id="end_date_input"></label>
                    <label for="activity_type">Activity Type:
                        <select name="activity_type">
                            <option value="">All</option>
                            <option value="electricity" {% if activity_type == 'electricity' %}selected{% endif %}>Electricity</option>
                            <option value="flight" {% if activity_type == 'flight' %}selected{% endif %}>Flight</option>
                            <option value="shipping" {% if activity_type == 'shipping' %}selected{% endif %}>Shipping</option>
                            <option value="fuel_combustion" {% if activity_type == 'fuel_combustion' %}selected{% endif %}>Fuel Combustion</option>
                            <option value="vehicle" {% if activity_type == 'vehicle' %}selected{% endif %}>Vehicle</option>
                        </select>
                    </label>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button type="submit" id="filter_button" style="padding: 10px 20px; font-size: 1.2em;">Filter</button>
                </div>
            </form>
        </div>

        <h2 style="margin-top: 20px; text-align: center;">Total Emissions: {{ total_emissions }} kg CO2e</h2>

        <div style="text-align: center;">
            <a href="{% url 'export_csv' %}?start_date={{ start_date }}&end_date={{ end_date }}&activity_type={{ activity_type }}" style="font-size: 1.2em;">Export to CSV</a>
        </div>

        {% if emissions %}
        <table border="1" style="width: 100%; margin-top: 20px;" id="emissionTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Activity Type</th>
                    <th>Input Parameters</th>
                    <th>Emission (kg CO2e)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for emission in emissions %}
                <tr id="emission-{{ emission.timestamp_str|cut:":"|cut:"." }}">
                    <td>{{ emission.timestamp|date:"Y-m-d H:i:s" }}</td>
                    <td>{{ emission.activity_type }}</td>
                    <td>
                        {% if emission.activity_type == 'electricity' %}
                        Value: {{ emission.input_params.value }}, Location: {{ emission.input_params.location }}, Unit: {{ emission.input_params.unit }}
                        {% elif emission.activity_type == 'flight' %}
                        Passengers: {{ emission.input_params.passengers }}, Legs:
                        {% for leg in emission.input_params.legs %}
                        (Departure: {{ leg.departure_airport }}, Destination: {{ leg.destination_airport }})
                        {% endfor %}
                        {% elif emission.activity_type == 'shipping' %}
                        Transport: {{ emission.input_params.transport_method }}, Distance: {{ emission.input_params.distance_value }} {{ emission.input_params.distance_unit }}, Weight: {{ emission.input_params.weight_value }} {{ emission.input_params.weight_unit }}
                        {% elif emission.activity_type == 'fuel_combustion' %}
                        Fuel Source Type: {{ emission.input_params.fuel_source_type }}, Fuel Source Unit: {{ emission.input_params.fuel_source_unit }}, Fuel Source Value: {{ emission.input_params.fuel_source_value }}
                        {% elif emission.activity_type == 'vehicle' %}
                        Distance Value: {{ emission.input_params.distance_value }}, Distance Unit: {{ emission.input_params.distance_unit }}, Vehicle Model: {{ emission.input_params.vehicle_model }}
                        {% endif %}
                    </td>
                    <td>{{ emission.carbonKg }}</td>
                    <td>
                        <button class="delete-button" data-timestamp="{{ emission.timestamp_str }}">
                            Delete
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="text-align: center;">No emission reports found.</p>
        {% endif %}

        <div style="margin-top: 20px;">
            <div style="width: 100%; margin-bottom: 20px;">
                {% if chart_image_line %}
                <h3 style="text-align: center;">Emissions Over Time</h3>
                <div style="text-align: center;"><img src="data:image/png;base64,{{ chart_image_line }}" alt="Line Chart" style="max-width: 80%; height: auto;"></div>
                {% if s3_line_url %}
                <p style="text-align: center;"><a href="{{ s3_line_url }}" target="_blank" style="font-size: 1.2em;">Download Line Chart</a></p>
                {% endif %}
                {% endif %}
            </div>

            <div style="width: 100%; margin-bottom: 20px;">
                {% if chart_image_bar %}
                <h3 style="text-align: center;">Emissions by Activity Type</h3>
                <div style="text-align: center;"><img src="data:image/png;base64,{{ chart_image_bar }}" alt="Bar Chart" style="max-width: 80%; height: auto;"></div>
                {% if s3_bar_url %}
                <p style="text-align: center;"><a href="{{ s3_bar_url }}" target="_button" style="font-size: 1.2em;">Download Bar Chart</a></p>
                {% endif %}
                {% endif %}
            </div>

            <div style="width: 100%;">
                {% if chart_image_pie %}
                <h3 style="text-align: center;">Emission Distribution</h3>
                <div style="text-align: center;"><img src="data:image/png;base64,{{ chart_image_pie }}" alt="Pie Chart" style="max-width: 80%; height: auto;"></div>
                {% if s3_pie_url %}
                <p style="text-align: center;"><a href="{{ s3_pie_url }}" target="_blank" style="font-size: 1.2em;">Download Pie Chart</a></p>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script>
  $(document).ready(function() {
    // Initialize DataTable with simple_numbers pagination type
    $('#emissionTable').DataTable({
  "paging": true,
  "pagingType": "simple_numbers",
  "searching": true,
  "info": true,
  "order": [[0, 'asc']],
  "drawCallback": function(settings) {
    // Iterate over all pagination buttons each time the table is drawn
    $('.dataTables_paginate .paginate_button').each(function(){
      // Remove any existing non-breaking spaces (in case they were already added)
      $(this).nextUntil('.paginate_button').remove();
      // Append a non-breaking space after each pagination button
      $(this).after(document.createTextNode("\u00A0"));
    });
  }
});
    
    let end_date_width = $('#end_date_input').outerWidth();
    $('#filter_button').css('width', end_date_width + 'px');

    // Inline delete functionality using AJAX
    $('.delete-button').on('click', function() {
      if (confirm("Are you sure you want to delete this emission record?")) {
        var button = $(this);
        var rawTimestamp = button.data('timestamp');
        $.ajax({
          url: "{% url 'delete_emission' %}",
          type: "POST",
          data: {
            'timestamp': rawTimestamp,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
          },
          success: function(response) {
            if (response.success) {
              var safeTimestamp = rawTimestamp.replace(/[:.]/g, '');
              $('#emission-' + safeTimestamp).fadeOut(500, function() {
                $(this).remove();
                setTimeout(function() {
                  location.reload();
                }, 500);
              });
            } else {
              alert("Error: " + response.error);
            }
          },
          error: function(xhr, status, error) {
            alert("Deletion failed: " + error);
          }
        });
      }
    });
  });
</script>
{% endblock content %}
