{% extends "CarbonTracker/base_generic.html" %} {# Extend the base template for consistent layout #}

{% block content %}

<div style="display: flex;">
    {# Sidebar with navigation links #}
    <div style="width: 200px; background-color: #e0e0e0; padding: 10px; height: 100vh; font-size: 1.2em;">
        <a href="{% url 'calculate_emission' %}" style="font-size: 1.2em;">Calculate Emission</a><br><br>
        <a href="{% url 'emission_reports' %}" style="font-size: 1.2em;">Emission Reports</a>
    </div>

    {# Main content area #}
    <div style="padding: 20px; flex-grow: 1; font-size: 1.2em;">
        
        <h1 style="text-align: center; font-size: 1.5em;">Carbon Footprint Tracker</h1>

        {# Emission calculation form #}
        <form method="post" style="margin-top: 20px;">
            {% csrf_token %}
            
            {# Render the activity type selection dropdown #}
            <div style="text-align: center;">
                {{ activity_form.as_p }}
            </div>

            {# Dynamically render fields based on the selected activity type #}
            <div style="margin-top: 10px; text-align: center;">
                {% if activity_type == 'electricity' %}
                    {{ form.as_p }}
                {% elif activity_type == 'flight' %}
                    {# Flight-specific form fields with airport code search links #}
                    <p>
                        {{ form.departure_airport.label_tag }}
                        {{ form.departure_airport }}
                        <a href="https://www.iata.org/en/publications/directories/code-search/" target="_blank">Search Airport Code</a>
                    </p>
                    <p>
                        {{ form.destination_airport.label_tag }}
                        {{ form.destination_airport }}
                        <a href="https://www.iata.org/en/publications/directories/code-search/" target="_blank">Search Airport Code</a>
                    </p>
                    <p>
                        {{ form.passengers.label_tag }}
                        {{ form.passengers }}
                    </p>
                {% elif activity_type == 'shipping' %}
                    {{ form.as_p }}
                {% elif activity_type == 'fuel_combustion' %}
                    {{ form.as_p }}
                {% elif activity_type == 'vehicle' %}
                
                    {# Vehicle activity: make dropdown, then conditional model, distance fields #}
                    <p>
                        {{ form.vehicle_make.label_tag }}
                        <select name="vehicle_make" id="id_vehicle_make">
                            {% for make in form.vehicle_make.field.choices %}
                                <option value="{{ make.0 }}" {% if make.0 == request.GET.vehicle_make %}selected{% endif %}>
                                    {{ make.1 }}
                                </option>
                            {% endfor %}
                        </select>
                    </p>

                    {# Show model and distance fields if vehicle_make is selected #}
                    {% if request.GET.vehicle_make or request.POST.vehicle_make %}
                        <p>
                            {{ form.vehicle_model.label_tag }}
                            {{ form.vehicle_model }}
                        </p>

                        <p>
                            {{ form.distance_value.label_tag }}
                            {{ form.distance_value }}
                        </p>
                        <p>
                            {{ form.distance_unit.label_tag }}
                            {{ form.distance_unit }}
                        </p>
                    {% endif %}
                {% endif %}
            </div>

            {# Submit button #}
            <div style="margin-top: 20px; text-align: center;">
                <button type="submit" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; font-size: 1.2em;">Calculate</button>
            </div>

            {# Display result or errors after form submission #}
            <div id="emission-result" style="margin-top: 20px; text-align: center;">
                {% if form.errors %}
                    <div style="color: red;">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <p>{{ field|title }}: {{ error }}</p>
                            {% endfor %}
                        {% endfor %}
                    </div>
                {% endif %}
                {% if error %}
                    <p style="color: red;">{{ error }}</p>
                {% endif %}
                {% if result %}
                    <p>{{ result }}</p>
                    <a href="{% url 'emission_reports' %}">View Emission Report</a>
                {% endif %}
            </div>
        </form>

        {# JavaScript to handle dynamic form updates and validation #}
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // Handle activity type change
                const activitySelect = document.getElementById('id_activity_type');
                if (activitySelect) {
                    activitySelect.addEventListener('change', () => {
                        const selectedActivity = activitySelect.value;
                        const url = new URL(window.location.href);
                        url.searchParams.set('activity_type', selectedActivity);
                        window.location.href = url.href;
                    });
                }

                // Handle vehicle make change
                const makeSelect = document.getElementById('id_vehicle_make');
                if (makeSelect) {
                    makeSelect.addEventListener('change', (event) => {
                        event.preventDefault();
                        const url = new URL(window.location.href);
                        url.searchParams.set('vehicle_make', makeSelect.value);
                        url.searchParams.set('activity_type', 'vehicle'); // Force activity_type to 'vehicle'
                        window.location.href = url.href;
                    });
                }

                // Prevent form submission if required fields are empty
                const calculateButton = document.querySelector('button[type="submit"]');
                if (calculateButton) {
                    calculateButton.addEventListener('click', (event) => {
                        const vehicleModel = document.getElementById('id_vehicle_model');
                        const distanceValue = document.getElementById('id_distance_value');
                        const distanceUnit = document.getElementById('id_distance_unit');

                        if (vehicleModel && vehicleModel.value === '') {
                            alert('Please select a vehicle model.');
                            event.preventDefault();
                        }

                        if (distanceValue && distanceValue.value === '') {
                            alert('Please enter a distance value.');
                            event.preventDefault();
                        }

                        if (distanceUnit && distanceUnit.value === '') {
                            alert('Please select a distance unit.');
                            event.preventDefault();
                        }
                    });
                }
            });
        </script>
    </div>
</div>
{% endblock content %}
